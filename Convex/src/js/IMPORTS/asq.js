!function(n,e,t){"function"==typeof define&&define.amd?define(t):"undefined"!=typeof module&&module.exports?module.exports=t():e[n]=t(n,e)}("ASQ",this,function n(e,t){"use strict";var u,r,l,c,i,f="undefined"!=typeof setImmediate?function(n){return setImmediate(n)}:setTimeout;function a(n){r.add(n),u||(u=f(r.drain))}function o(n){function e(){n.seq=p.apply(A,arguments).defer()}e.fail=function(){var e=E.call(arguments);n.seq=p(function(n){n.fail.apply(A,e)}).defer()},n.seq.val(function(){return e.apply(A,arguments),q.apply(A,arguments)}).or(function(){e.fail.apply(A,arguments)}),n.seq=p(function(n){e=n}).defer()}function p(){function n(){w?t():k||(k=a(t))}function e(){throw 1===Q.length?Q[0]:Q}function t(){var t,u;if(k=null,delete C.unpause,w)clearTimeout(k),k=null,O.length=T.length=I.length=Q.length=0;else if(x)for(0!==T.length||j||(j=!0,e());T.length;){j=!0,t=T.shift();try{t.apply(A,Q)}catch(n){m(n)?Q=Q.concat(n):(Q.push(n),n.stack&&Q.push(n.stack)),0===T.length&&e()}}else if(S&&O.length>0){S=!1,t=O.shift(),u=I.slice(),I.length=0,u.unshift(function(){function e(){x||w||S||t||(t=!0,S=!0,I.push.apply(I,arguments),Q.length=0,n())}e.fail=function(){x||w||S||t||(x=!0,I.length=0,Q.push.apply(Q,arguments),n())},e.abort=function(){x||w||(S=!1,w=!0,I.length=Q.length=0,n())},e.errfcb=function(n){n?e.fail(n):e.apply(A,E.call(arguments,1))};var t=!1;return e}());try{t.apply(A,u)}catch(e){m(e)?Q=Q.concat(e):Q.push(e),x=!0,n()}}}function u(n,e,t){function u(){clearTimeout(o),o=y=d=f=null}function r(){if(s)return l();o||(o=a(l))}function l(){if(!(x||w||h)){var e=[];o=null,p?(n.fail.apply(A,f),u()):s?(n.abort(),u()):function(){if(0===y.length)return;var n=!0;return y.some(function(e){if(null===e)return n=!1,!0}),n}()&&(h=!0,y.forEach(function(n,t){e.push(d["s"+t])}),n.apply(A,e),u())}}var c,i,f,o,p=!1,s=!1,h=!1,y=[],d={};e.some(function(n){if(p||s)return!0;(c=t.slice()).unshift(function(){function n(){if(!(x||w||p||s||h||y[e])){var n=q.apply(A,arguments);d["s"+e]=n.length>1?n:n[0],y[e]=!0,r()}}var e=y.length;return n.fail=function(){x||w||p||s||h||y[e]||(p=!0,f=E.call(arguments),r())},n.abort=function(){x||w||p||s||h||(s=!0,l())},n.errfcb=function(e){e?n.fail(e):n.apply(A,E.call(arguments,1))},y[e]=null,n}());try{n.apply(A,c)}catch(n){return i=n,p=!0,!0}}),i&&(m(i)?n.fail.apply(A,i):n.fail(i))}function r(){return x||w||0===arguments.length?C:(g(arguments,d).forEach(function(n){_(n)?i(n):O.push(n)}),n(),C)}function l(){return w||0===arguments.length?C:(T.push.apply(T,arguments),n(),C)}function c(){if(x||w||0===arguments.length)return C;var n=E.call(arguments).map(function(n){var e;return _(n)?(o(e={seq:n}),function(n){e.seq.pipe(n)}):n});return r(function(e){var t=E.call(arguments,1);u(e,n,t)}),C}function i(){return x||w||0===arguments.length?C:(E.call(arguments).forEach(function(n){var e={seq:n};_(n)&&o(e),r(function(n){var t=e.seq;_(t)||(t=e.seq.apply(A,E.call(arguments,1))),t.pipe(n)})}),C)}function f(){return x||w||0===arguments.length?C:(E.call(g(arguments,y)).forEach(function(n){r(function(e){var t=n.apply(A,E.call(arguments,1));m(t)||(t=q(t)),e.apply(A,t)})}),C)}function h(n,e){var t=arguments.length>1;switch(n){case"seq_error":if(!t)return x;x=e;break;case"seq_aborted":if(!t)return w;w=e;break;case"then_ready":if(!t)return S;S=e;break;case"then_queue":return O;case"or_queue":return T;case"sequence_messages":return I;case"sequence_errors":return Q}}var k,x=!1,j=!1,w=!1,S=!0,O=[],T=[],I=[],Q=[],C=s({then:r,or:l,onerror:l,gate:c,all:c,pipe:function(){return w||0===arguments.length?C:(E.call(arguments).forEach(function(n){r(function(e){n.apply(A,E.call(arguments,1)),e()}).or(n.fail)}),C)},seq:i,val:f,promise:function(){function n(n){return function(){n.apply(A,m(arguments[0])?arguments[0]:arguments)}}return x||w||0===arguments.length?C:(E.call(arguments).forEach(function(e){r(function(t){var u=e;"function"==typeof e&&"function"!=typeof e.then&&(u=e.apply(A,E.call(arguments,1))),u.then(n(t),n(t.fail))})}),C)},fork:function(){var n;return f(function(){return n?n.apply(A,arguments):n=p.apply(A,arguments).defer(),q.apply(A,arguments)}),l(function(){if(n)n.fail.apply(A,arguments);else{var e=E.call(arguments);n=p().then(function(n){n.fail.apply(A,e)}).defer()}}),p().then(function(e){n?n.pipe(e):n=e}).defer()},abort:function(){return x?C:(w=!0,t(),C)},duplicate:function(){var n;return v={then_queue:O.slice(),or_queue:T.slice()},n=p(),v=null,n},defer:function(){return T.push(function(){}),C}});return Object.keys(b).forEach(function(n){C[n]=C[n]||b[n](C,h)}),v&&(O=v.then_queue.slice(),T=v.or_queue.slice(),C.unpause=function(){I.push.apply(I,arguments),!0===k&&(k=null),n()},k=!0),C.then.apply(A,arguments),C}function s(n){return Object.defineProperty(n,x,{enumerable:!1,value:!0})}function h(n){return!(null==n||"object"!=typeof n||!n[x])}function y(n){return q.apply(A,E.call(arguments).slice(1,n+1))}function d(n){arguments[n+1].apply(A,E.call(arguments).slice(1,n+1))}function g(n,e){var t,u;for(n=E.call(n),t=0;t<n.length;t++)if(m(n[t]))n[t]=e.bind.apply(e,[null,n[t].length].concat(n[t]));else if("function"!=typeof n[t]&&(e===y||!_(n[t]))){for(u=t+1;u<n.length&&("function"!=typeof n[u]&&!h(n[u]));u++);n.splice(t,u-t,e.bind.apply(e,[null,u-t].concat(n.slice(t,u))))}return n}r={add:function(n){i=new function(n){this.fn=n,this.next=void 0}(n),c?c.next=i:l=i,c=i,i=void 0},drain:function(){var n=l;for(l=c=u=null;n;)n.fn(),n=n.next}};var v,q,_,m,b={},k=(t||{})[e],E=[].slice,x="__ASQ__",A=Object.create(null);return p.failed=function(){var n=q.apply(A,arguments);return p(function(){throw n}).defer()},p.extend=function(n,e){return b[n]=e,p},p.messages=q=function(){return s(E.call(arguments))},p.isSequence=_=function(n){return h(n)&&!Array.isArray(n)},p.isMessageWrapper=m=function(n){return h(n)&&Array.isArray(n)},p.unpause=function(n){return n.unpause&&n.unpause(),n},p.noConflict=function(){return t&&(t[e]=k),p},p.clone=function(){return n(e,t)},p.__schedule=a,p.__tapSequence=o,p});
