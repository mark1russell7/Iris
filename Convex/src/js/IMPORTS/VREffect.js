THREE.VREffect=function(e,t){var i,r,n,a,s=new THREE.Vector3,o=new THREE.Vector3,h=new THREE.Matrix4,l=new THREE.Matrix4,d=new THREE.Matrix4,u=null;"VRFrameData"in window&&(u=new window.VRFrameData),navigator.getVRDisplays&&navigator.getVRDisplays().then(function(e){r=e,e.length>0?i=e[0]:t&&t("HMD not available")}).catch(function(){console.warn("THREE.VREffect: Unable to get VR Displays")}),this.isPresenting=!1;var c=this,g=e.getSize(),f=!1,p=e.getPixelRatio();this.getVRDisplay=function(){return i},this.setVRDisplay=function(e){i=e},this.getVRDisplays=function(){return console.warn("THREE.VREffect: getVRDisplays() is being deprecated."),r},this.setSize=function(t,r,n){if(g={width:t,height:r},f=n,c.isPresenting){var a=i.getEyeParameters("left");e.setPixelRatio(1),e.setSize(2*a.renderWidth,a.renderHeight,!1)}else e.setPixelRatio(p),e.setSize(t,r,n)};var w=e.domElement,m=[0,0,.5,1],y=[.5,0,.5,1];function x(){var t=c.isPresenting;if(c.isPresenting=void 0!==i&&i.isPresenting,c.isPresenting){var r=i.getEyeParameters("left"),n=r.renderWidth,a=r.renderHeight;t||(p=e.getPixelRatio(),g=e.getSize(),e.setPixelRatio(1),e.setSize(2*n,a,!1))}else t&&(e.setPixelRatio(p),e.setSize(g.width,g.height,f))}window.addEventListener("vrdisplaypresentchange",x,!1),this.setFullScreen=function(e){return new Promise(function(t,r){void 0!==i?c.isPresenting!==e?t(e?i.requestPresent([{source:w}]):i.exitPresent()):t():r(new Error("No VR hardware found."))})},this.requestPresent=function(){return this.setFullScreen(!0)},this.exitPresent=function(){return this.setFullScreen(!1)},this.requestAnimationFrame=function(e){return void 0!==i?i.requestAnimationFrame(e):window.requestAnimationFrame(e)},this.cancelAnimationFrame=function(e){void 0!==i?i.cancelAnimationFrame(e):window.cancelAnimationFrame(e)},this.submitFrame=function(){void 0!==i&&c.isPresenting&&i.submitFrame()},this.autoSubmitFrame=!0;var v=new THREE.PerspectiveCamera;v.layers.enable(1);var E=new THREE.PerspectiveCamera;E.layers.enable(2),this.render=function(t,r,g,f){if(i&&c.isPresenting){var p=t.autoUpdate;p&&(t.updateMatrixWorld(),t.autoUpdate=!1),Array.isArray(t)&&(console.warn("THREE.VREffect.render() no longer supports arrays. Use object.layers instead."),t=t[0]);var w,x,P=e.getSize(),V=i.getLayers();if(V.length){var F=V[0];w=null!==F.leftBounds&&4===F.leftBounds.length?F.leftBounds:m,x=null!==F.rightBounds&&4===F.rightBounds.length?F.rightBounds:y}else w=m,x=y;if(n={x:Math.round(P.width*w[0]),y:Math.round(P.height*w[1]),width:Math.round(P.width*w[2]),height:Math.round(P.height*w[3])},a={x:Math.round(P.width*x[0]),y:Math.round(P.height*x[1]),width:Math.round(P.width*x[2]),height:Math.round(P.height*x[3])},g?(e.setRenderTarget(g),g.scissorTest=!0):(e.setRenderTarget(null),e.setScissorTest(!0)),(e.autoClear||f)&&e.clear(),null===r.parent&&r.updateMatrixWorld(),r.matrixWorld.decompose(v.position,v.quaternion,v.scale),E.position.copy(v.position),E.quaternion.copy(v.quaternion),E.scale.copy(v.scale),i.getFrameData)i.depthNear=r.near,i.depthFar=r.far,i.getFrameData(u),v.projectionMatrix.elements=u.leftProjectionMatrix,E.projectionMatrix.elements=u.rightProjectionMatrix,function(e){e.pose.orientation?(R.fromArray(e.pose.orientation),h.makeRotationFromQuaternion(R)):h.identity();e.pose.position&&(T.fromArray(e.pose.position),h.setPosition(T));l.fromArray(e.leftViewMatrix),l.multiply(h),d.fromArray(e.rightViewMatrix),d.multiply(h),l.getInverse(l),d.getInverse(d)}(u),v.updateMatrix(),v.matrix.multiply(l),v.matrix.decompose(v.position,v.quaternion,v.scale),E.updateMatrix(),E.matrix.multiply(d),E.matrix.decompose(E.position,E.quaternion,E.scale);else{var H=i.getEyeParameters("left"),S=i.getEyeParameters("right");v.projectionMatrix=M(H.fieldOfView,!0,r.near,r.far),E.projectionMatrix=M(S.fieldOfView,!0,r.near,r.far),s.fromArray(H.offset),o.fromArray(S.offset),v.translateOnAxis(s,v.scale.x),E.translateOnAxis(o,E.scale.x)}return g?(g.viewport.set(n.x,n.y,n.width,n.height),g.scissor.set(n.x,n.y,n.width,n.height)):(e.setViewport(n.x,n.y,n.width,n.height),e.setScissor(n.x,n.y,n.width,n.height)),e.render(t,v,g,f),g?(g.viewport.set(a.x,a.y,a.width,a.height),g.scissor.set(a.x,a.y,a.width,a.height)):(e.setViewport(a.x,a.y,a.width,a.height),e.setScissor(a.x,a.y,a.width,a.height)),e.render(t,E,g,f),g?(g.viewport.set(0,0,P.width,P.height),g.scissor.set(0,0,P.width,P.height),g.scissorTest=!1,e.setRenderTarget(null)):(e.setViewport(0,0,P.width,P.height),e.setScissorTest(!1)),p&&(t.autoUpdate=!0),void(c.autoSubmitFrame&&c.submitFrame())}e.render(t,r,g,f)},this.dispose=function(){window.removeEventListener("vrdisplaypresentchange",x,!1)};var R=new THREE.Quaternion,T=new THREE.Vector3;function M(e,t,i,r){var n=Math.PI/180;return function(e,t,i,r){i=void 0===i?.01:i,r=void 0===r?1e4:r;var n=(t=void 0===t||t)?-1:1,a=new THREE.Matrix4,s=a.elements,o=function(e){var t=2/(e.leftTan+e.rightTan),i=(e.leftTan-e.rightTan)*t*.5,r=2/(e.upTan+e.downTan);return{scale:[t,r],offset:[i,(e.upTan-e.downTan)*r*.5]}}(e);return s[0]=o.scale[0],s[1]=0,s[2]=o.offset[0]*n,s[3]=0,s[4]=0,s[5]=o.scale[1],s[6]=-o.offset[1]*n,s[7]=0,s[8]=0,s[9]=0,s[10]=r/(i-r)*-n,s[11]=r*i/(i-r),s[12]=0,s[13]=0,s[14]=n,s[15]=0,a.transpose(),a}({upTan:Math.tan(e.upDegrees*n),downTan:Math.tan(e.downDegrees*n),leftTan:Math.tan(e.leftDegrees*n),rightTan:Math.tan(e.rightDegrees*n)},t,i,r)}};